/*
* Andrey Lysikov (C) 2014
* Licensed under the MIT license:
*   http://www.opensource.org/licenses/mit-license.php
* v1.0 - release 24.01.2013
* v1.1 - 11.02.2013
*	 - добавлена перезагрузка формы после отсылки файла
*	   чтобы не приходилось перезагружать страницу
*
* Использование:
* $(<element>).jInputFile();
*
* Параметры:
* url - Путь к обработчику POST
* filename - Имя файла для загрузки в пост
* iframe - Метод загрузки: если true то фреймом
* heigth - Высота элемента в пикселах
* width - Ширина в пикселах
*		
* Возвращаемые функции:
* success: Загрузка завершена
* selected: Когда один из файлов выбран
*/
(function(b){b.widget("ui.jInputFile",{options:{url:null,filename:null,reloaded:0,heigth:30,width:250,iframe:/msie/.test(navigator.userAgent.toLowerCase())?!0:!1},_create:function(){if(this.options.iframe){var a=this;b("<iframe />").attr({src:"about:blank",style:"border: 0;heigth: "+a.options.heigth+"px;width: "+a.options.width+"px"}).prependTo(a.element.parent()).css("overflow","hidden").load(function(){0!=a.options.reloaded&&a._trigger("success",null);a.element.parent().find("iframe").contents().find("body").append(b("<form />").attr({method:"POST",
action:a.options.url,enctype:"multipart/form-data"}).css("overflow","hidden")).children("form").append(a.element.clone(!0).attr({name:a.options.filename,id:"file_iframe_upload"}).css("overflow","hidden").show().change(function(){a._trigger("selected",null)}));a.element.parent().find("iframe").contents().find("body").children("form").append(b("<input />").attr({type:"submit",value:"\u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c","class":"submit"}).hide()).append(b("<input />").attr({type:"reset",
value:"\u041e\u0442\u0447\u0438\u0441\u0442\u0438\u0442\u044c","class":"reset"}).hide());a.options.reloaded+=1});a.element.hide()}else this.element.wrap(b("<form />").attr({style:"heigth: "+this.options.heigth+"px;width: "+this.options.width+"px",enctype:"multipart/form-data"})),this._create_ajax_from(this)},submit:function(){this.options.iframe?(this.element.parent().find("iframe").hide().contents().find("body").children("form").children(".submit").click(),this.element.parent().find("iframe").css("overflow",
"hidden")):this._submit_ajax_from()},clear:function(){this.options.iframe?this.element.parent().find("iframe").show().contents().find("body").children("form").children(".reset").click():(b(this.element).parent().children(".reset").click(),b(this.element).parent().children(".jInputFile-filename").empty().append("\u043d\u0435\u0432\u044b\u0431\u0440\u0430\u043d \u0444\u0430\u0439\u043b"),b(this.element).parent().children(".jInputFile-fakeButton").button("option","disabled",!1))},_create_ajax_from:function(a){a.element.hide();
null!==a.options.filename&&a.element.attr("name",a.options.filename);a.element.after(b("<input />").attr({type:"reset",value:"\u041e\u0442\u0447\u0438\u0441\u0442\u0438\u0442\u044c","class":"reset"}).hide());a.element.after('<button class="jInputFile-fakeButton">\u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0444\u0430\u0439\u043b...</button><div class="jInputFile-filename" style="font-size:80%">\u043d\u0435\u0432\u044b\u0431\u0440\u0430\u043d \u0444\u0430\u0439\u043b</div>');a.element.parent().children(".jInputFile-fakeButton").button({icons:{primary:"ui-icon-plusthick"}}).click(function(b){a.element.parent().children("input[type='file']").click();
return!1});b(a.element).change(function(){var c=b(a.element).val(),c=c.replace(/.*\\(.*)/,"$1"),c=c.replace(/.*\/(.*)/,"$1");b(a.element).parent().children(".jInputFile-filename").html(c);b(a.element).parent().children(".jInputFile-fakeButton").button("option","disabled",!0);a._trigger("selected",null)})},_submit_ajax_from:function(){var a=this,c=new FormData;c.append(b(a.element).attr("name"),a.element[0].files[0]);b(a.element).parent().children(".jInputFile-filename").empty();b.ajax({url:a.options.url,
data:c,processData:!1,contentType:!1,datatype:"json",cache:!1,type:"POST",success:function(c){b(a.element).parent().children(".jInputFile-filename").empty().append("\u043d\u0435\u0432\u044b\u0431\u0440\u0430\u043d \u0444\u0430\u0439\u043b");a._trigger("success",c)}})},_setOption:function(a,c){b.Widget.prototype._setOption.apply(this,arguments);switch(a){case "url":this.options.iframe&&this.element.parent().find("iframe").contents().find("body").children("form").attr("action",c)}}})})(jQuery);